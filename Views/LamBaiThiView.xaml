<Window x:Class="SEP490_G18_GESS_DESKTOPAPP.Views.LamBaiThiView"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:SEP490_G18_GESS_DESKTOPAPP.Views"
        xmlns:avalonedit="http://icsharpcode.net/sharpdevelop/avalonedit"
        xmlns:controls="clr-namespace:WpfMath.Controls;assembly=WpfMath"
        mc:Ignorable="d"
        Title="{Binding WindowTitle}" Background="#F7F9FC" WindowState="Maximized">

    <Window.Resources>
        <!-- Converters -->
        <local:ExamTypeToVisibilityConverter x:Key="ExamTypeToVisibilityConverter"/>
        <local:QuestionButtonStyleConverter x:Key="QuestionButtonStyleConverter"/>
        <local:IsMarkedToTextConverter x:Key="IsMarkedToTextConverter"/>
        <local:IndexToAlphabetConverter x:Key="IndexToAlphabetConverter"/>
        <local:AddOneConverter x:Key="AddOneConverter"/>
        <local:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <local:BoolToVisibilityParameterConverter x:Key="BoolToVisibilityParameterConverter"/>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>

        <!-- Color Resources - Đồng bộ với design system -->
        <SolidColorBrush x:Key="PrimaryColor" Color="#3182CE"/>
        <SolidColorBrush x:Key="CardBackground" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="BorderColor" Color="#E2E8F0"/>
        <SolidColorBrush x:Key="DarkText" Color="#2D3748"/>
        <SolidColorBrush x:Key="MediumText" Color="#4A5568"/>
        <SolidColorBrush x:Key="LightText" Color="#718096"/>
        <SolidColorBrush x:Key="SuccessColor" Color="#16A34A"/>
        <SolidColorBrush x:Key="WarningColor" Color="#F59E0B"/>
        <SolidColorBrush x:Key="ErrorColor" Color="#E53E3E"/>
        <SolidColorBrush x:Key="IconBackground" Color="#F7FAFC"/>

        <!-- Button Styles -->
        <Style x:Key="NumberButtonStyle" TargetType="Button">
            <Setter Property="Width" Value="40"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="Margin" Value="3"/>
            <Setter Property="Background" Value="{StaticResource CardBackground}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderColor}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="Medium"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                        BorderBrush="{TemplateBinding BorderBrush}"
                        BorderThickness="{TemplateBinding BorderThickness}"
                        CornerRadius="8">
                            <ContentPresenter HorizontalAlignment="Center"
                                    VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#F7FAFC"/>
                                <Setter Property="BorderBrush" Value="{StaticResource PrimaryColor}"/>
                                <Setter Property="BorderThickness" Value="2"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="CurrentButtonStyle" TargetType="Button" BasedOn="{StaticResource NumberButtonStyle}">
            <Setter Property="Background" Value="{StaticResource PrimaryColor}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderBrush" Value="{StaticResource PrimaryColor}"/>
        </Style>

        <Style x:Key="AnsweredButtonStyle" TargetType="Button" BasedOn="{StaticResource NumberButtonStyle}">
            <Setter Property="Background" Value="{StaticResource SuccessColor}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderBrush" Value="{StaticResource SuccessColor}"/>
        </Style>

        <Style x:Key="MarkedButtonStyle" TargetType="Button" BasedOn="{StaticResource NumberButtonStyle}">
            <Setter Property="Background" Value="{StaticResource WarningColor}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderBrush" Value="{StaticResource WarningColor}"/>
        </Style>

        <!-- Radio Button Style for Single Choice -->
        <Style x:Key="AnswerRadioButtonStyle" TargetType="RadioButton">
            <Setter Property="Margin" Value="0,6,0,6"/>
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="IsHitTestVisible" Value="True"/>
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="RadioButton">
                        <Border x:Name="border" 
                                Background="{StaticResource IconBackground}" 
                                BorderBrush="{StaticResource BorderColor}" 
                                BorderThickness="1" 
                                CornerRadius="12"
                                Padding="16,14"
                                IsHitTestVisible="True">
                            <Grid IsHitTestVisible="True">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <!-- Radio Circle -->
                                <Grid Grid.Column="0" Width="24" Height="24" Margin="0,0,12,0" IsHitTestVisible="False">
                                    <Ellipse x:Name="outerEllipse" 
                                            Fill="White" 
                                            Stroke="{StaticResource LightText}" 
                                            StrokeThickness="2"
                                            IsHitTestVisible="False"/>
                                    <Ellipse x:Name="innerEllipse" 
                                            Width="12" Height="12" 
                                            Fill="{StaticResource PrimaryColor}" 
                                            Visibility="Collapsed"
                                            IsHitTestVisible="False"/>
                                </Grid>

                                <!-- Answer Label (A, B, C, D) -->
                                <Border Grid.Column="1" 
                                        Background="{StaticResource BorderColor}" 
                                        CornerRadius="6" 
                                        Width="32" Height="32" 
                                        Margin="0,0,12,0"
                                        IsHitTestVisible="False">
                                    <TextBlock Text="{Binding RelativeSource={RelativeSource TemplatedParent}, Path=Tag}" 
                                             HorizontalAlignment="Center" 
                                             VerticalAlignment="Center"
                                             FontWeight="SemiBold"
                                             Foreground="{StaticResource DarkText}"
                                             IsHitTestVisible="False"/>
                                </Border>

                                <!-- Content -->
                                <ContentPresenter Grid.Column="2" VerticalAlignment="Center" IsHitTestVisible="False"/>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="innerEllipse" Property="Visibility" Value="Visible"/>
                                <Setter TargetName="border" Property="Background" Value="#EBF8FF"/>
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryColor}"/>
                                <Setter TargetName="outerEllipse" Property="Stroke" Value="{StaticResource PrimaryColor}"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#F7FAFC"/>
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryColor}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- CheckBox Style for Multiple Choice -->
        <Style x:Key="AnswerCheckBoxStyle" TargetType="CheckBox">
            <Setter Property="Margin" Value="0,6,0,6"/>
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="IsHitTestVisible" Value="True"/>
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="CheckBox">
                        <Border x:Name="border" 
                                Background="{StaticResource IconBackground}" 
                                BorderBrush="{StaticResource BorderColor}" 
                                BorderThickness="1" 
                                CornerRadius="12"
                                Padding="16,14"
                                IsHitTestVisible="True">
                            <Grid IsHitTestVisible="True">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <!-- CheckBox Square -->
                                <Border Grid.Column="0" Width="24" Height="24" 
                                        Margin="0,0,12,0"
                                        BorderThickness="2"
                                        BorderBrush="{StaticResource LightText}"
                                        Background="White"
                                        CornerRadius="6"
                                        IsHitTestVisible="False">
                                    <Path x:Name="checkMark"
                                          Data="M4,10 L9,15 L20,4"
                                          Stroke="{StaticResource PrimaryColor}"
                                          StrokeThickness="3"
                                          Visibility="Collapsed"
                                          IsHitTestVisible="False"/>
                                </Border>

                                <!-- Answer Label (A, B, C, D) -->
                                <Border Grid.Column="1" 
                                        Background="{StaticResource BorderColor}" 
                                        CornerRadius="6" 
                                        Width="32" Height="32" 
                                        Margin="0,0,12,0"
                                        IsHitTestVisible="False">
                                    <TextBlock Text="{Binding RelativeSource={RelativeSource TemplatedParent}, Path=Tag}" 
                                             HorizontalAlignment="Center" 
                                             VerticalAlignment="Center"
                                             FontWeight="SemiBold"
                                             Foreground="{StaticResource DarkText}"
                                             IsHitTestVisible="False"/>
                                </Border>

                                <!-- Content -->
                                <ContentPresenter Grid.Column="2" VerticalAlignment="Center" IsHitTestVisible="False"/>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="checkMark" Property="Visibility" Value="Visible"/>
                                <Setter TargetName="border" Property="Background" Value="#EBF8FF"/>
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryColor}"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#F7FAFC"/>
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryColor}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Navigation Button Styles -->
        <Style x:Key="NavButtonStyle" TargetType="Button">
            <Setter Property="Height" Value="44"/>
            <Setter Property="Padding" Value="16,0"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="Medium"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="12"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center"
                                            VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="PrevButtonStyle" TargetType="Button" BasedOn="{StaticResource NavButtonStyle}">
            <Setter Property="Background" Value="{StaticResource MediumText}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderBrush" Value="{StaticResource MediumText}"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{StaticResource DarkText}"/>
                </Trigger>
                <Trigger Property="IsEnabled" Value="False">
                    <Setter Property="Background" Value="{StaticResource BorderColor}"/>
                    <Setter Property="Foreground" Value="{StaticResource LightText}"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="NextButtonStyle" TargetType="Button" BasedOn="{StaticResource NavButtonStyle}">
            <Setter Property="Background" Value="{StaticResource PrimaryColor}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderBrush" Value="{StaticResource PrimaryColor}"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#2C5282"/>
                </Trigger>
                <Trigger Property="IsEnabled" Value="False">
                    <Setter Property="Background" Value="{StaticResource BorderColor}"/>
                    <Setter Property="Foreground" Value="{StaticResource LightText}"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- Submit Button Style -->
        <Style x:Key="SubmitButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource SuccessColor}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Height" Value="50"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                CornerRadius="12">
                            <ContentPresenter HorizontalAlignment="Center"
                                            VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#15803D"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- Mark Button Style -->
        <Style x:Key="MarkButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource WarningColor}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Height" Value="32"/>
            <Setter Property="Padding" Value="16,0"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                CornerRadius="16"
                                Padding="{TemplateBinding Padding}">
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                <TextBlock Text="⭐" FontSize="14" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                <ContentPresenter VerticalAlignment="Center"/>
                            </StackPanel>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#D97706"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- Tab Style for Practice Exam -->
        <Style x:Key="ModernTabStyle" TargetType="TabItem">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabItem">
                        <Border x:Name="Border" 
                                Background="Transparent" 
                                BorderThickness="0,0,0,3"
                                BorderBrush="Transparent"
                                Padding="16,8"
                                Margin="0,0,16,0">
                            <ContentPresenter x:Name="ContentSite"
                                            VerticalAlignment="Center"
                                            HorizontalAlignment="Center"
                                            ContentSource="Header"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Border" Property="BorderBrush" Value="{StaticResource PrimaryColor}"/>
                                <Setter Property="Foreground" Value="{StaticResource PrimaryColor}"/>
                                <Setter Property="FontWeight" Value="Bold"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="#F3F4F6"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>

        <!-- Timer Style -->
        <Style x:Key="TimerBorderStyle" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource CardBackground}"/>
            <Setter Property="BorderBrush" Value="{StaticResource PrimaryColor}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="Padding" Value="20,12"/>
        </Style>

        <!-- Progress Bar Style -->
        <Style x:Key="RoundedProgressBar" TargetType="ProgressBar">
            <Setter Property="Height" Value="8"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ProgressBar">
                        <Border Background="{StaticResource BorderColor}" CornerRadius="4" Height="8">
                            <Border x:Name="PART_Track" Background="Transparent">
                                <Border x:Name="PART_Indicator" 
                                       Background="{StaticResource SuccessColor}" 
                                       CornerRadius="4"
                                       HorizontalAlignment="Left"/>
                            </Border>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <!-- Main Grid -->
    <Grid>
        <!-- Main Content -->
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="340"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Left Panel -->
            <Border Grid.Column="0" Background="{StaticResource CardBackground}" 
                    BorderBrush="{StaticResource BorderColor}" BorderThickness="0,0,1,0">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <Grid Margin="20">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- Header -->
                        <TextBlock Grid.Row="0" Text="Thông Tin Sinh Viên" 
                                FontSize="20" FontWeight="SemiBold" 
                                Foreground="{StaticResource DarkText}" Margin="0,0,0,20"/>

                        <!-- Student Info -->
                        <Border Grid.Row="1" Background="{StaticResource IconBackground}" 
                                CornerRadius="12" Padding="16" Margin="0,0,0,20"
                                BorderThickness="1" BorderBrush="{StaticResource BorderColor}">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="80"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <TextBlock Grid.Row="0" Grid.Column="0" Text="Họ tên:" 
                                        FontSize="14" Margin="0,4" Foreground="{StaticResource LightText}"/>
                                <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding StudentFullName}" 
                                        FontSize="14" FontWeight="Medium" Margin="0,4" Foreground="{StaticResource DarkText}"/>

                                <TextBlock Grid.Row="1" Grid.Column="0" Text="MSSV:" 
                                        FontSize="14" Margin="0,4" Foreground="{StaticResource LightText}"/>
                                <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding StudentCode}" 
                                        FontSize="14" FontWeight="Medium" Margin="0,4" Foreground="{StaticResource DarkText}"/>

                                <TextBlock Grid.Row="2" Grid.Column="0" Text="Môn thi:" 
                                        FontSize="14" Margin="0,4" Foreground="{StaticResource LightText}"/>
                                <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding SubjectName}" 
                                        FontSize="14" FontWeight="Medium" Margin="0,4" TextWrapping="Wrap" Foreground="{StaticResource DarkText}"/>

                                <TextBlock Grid.Row="3" Grid.Column="0" Text="Thể loại:" 
                                        FontSize="14" Margin="0,4" Foreground="{StaticResource LightText}"/>
                                <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding ExamCategoryName}" 
                                        FontSize="14" FontWeight="Medium" Margin="0,4" Foreground="{StaticResource DarkText}"/>
                            </Grid>
                        </Border>

                        <!-- Timer -->
                        <StackPanel Grid.Row="2" Margin="0,0,0,20">
                            <TextBlock Text="Thời gian còn lại" FontSize="16" FontWeight="SemiBold" 
                                    Foreground="{StaticResource DarkText}" Margin="0,0,0,10"/>
                            <Border Style="{StaticResource TimerBorderStyle}">
                                <TextBlock x:Name="TimerText" Text="{Binding TimerText}" 
                                        FontSize="32" FontWeight="SemiBold" 
                                        Foreground="{StaticResource PrimaryColor}" 
                                        HorizontalAlignment="Center"/>
                            </Border>
                        </StackPanel>

                        <!-- Progress -->
                        <StackPanel Grid.Row="3" Margin="0,0,0,20">
                            <TextBlock Text="Tiến trình làm bài" FontSize="14" FontWeight="SemiBold" 
                                    Foreground="{StaticResource DarkText}" Margin="0,0,0,6"/>
                            <TextBlock Text="{Binding ProgressText}" FontSize="13" 
                                    Foreground="{StaticResource LightText}" Margin="0,0,0,8"/>
                            <ProgressBar Value="{Binding ProgressValue}" 
                                        Style="{StaticResource RoundedProgressBar}"/>
                        </StackPanel>

                        <!-- Question Numbers Header -->
                        <TextBlock Grid.Row="4" Text="Danh sách câu hỏi" FontSize="14" FontWeight="SemiBold" 
                                Foreground="{StaticResource DarkText}" Margin="0,0,0,12"/>

                        <!-- Question Numbers Grid -->
                        <ScrollViewer Grid.Row="5" VerticalScrollBarVisibility="Auto" MaxHeight="250">
                            <ItemsControl ItemsSource="{Binding QuestionNumbers}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <UniformGrid Columns="5"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Button Content="{Binding Number}" 
                                                Command="{Binding DataContext.GoToQuestionCommand, 
                                                         RelativeSource={RelativeSource AncestorType=Window}}"
                                                CommandParameter="{Binding Number}">
                                            <Button.Style>
                                                <MultiBinding Converter="{StaticResource QuestionButtonStyleConverter}">
                                                    <Binding Path="IsAnswered"/>
                                                    <Binding Path="IsCurrent"/>
                                                    <Binding Path="IsMarked"/>
                                                    <Binding RelativeSource="{RelativeSource Self}"/>
                                                </MultiBinding>
                                            </Button.Style>
                                        </Button>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>

                        <!-- Navigation Buttons - Di chuyển từ bottom right sang đây -->
                        <Grid Grid.Row="6" Margin="0,20,0,10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Button Grid.Column="0" x:Name="PrevButton" Content="◀ Trước" 
                                    Style="{StaticResource PrevButtonStyle}" 
                                    Margin="0,0,4,0"
                                    Command="{Binding PreviousQuestionCommand}"/>
                            <Button Grid.Column="1" x:Name="NextButton" Content="Tiếp ▶" 
                                    Style="{StaticResource NextButtonStyle}" 
                                    Margin="4,0,0,0"
                                    Command="{Binding NextQuestionCommand}"/>
                        </Grid>
                        
                        <!-- Submit Button -->
                        <Button Grid.Row="7" Content="✓ Nộp Bài" 
                                Style="{StaticResource SubmitButtonStyle}" 
                                Command="{Binding SubmitExamCommand}"/>
                    </Grid>
                </ScrollViewer>
            </Border>

            <!-- Right Panel - Question Content -->
            <Grid Grid.Column="1" Background="#F7F9FC">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Multiple Choice Content -->
                <Border Grid.Row="0" Background="{StaticResource CardBackground}" Margin="24" CornerRadius="16" 
                        BorderBrush="{StaticResource BorderColor}" BorderThickness="1"
                        Visibility="{Binding ExamType, Converter={StaticResource ExamTypeToVisibilityConverter}, ConverterParameter=MultipleChoice}">
                    <Border.Effect>
                        <DropShadowEffect Color="#000000" Opacity="0.08" ShadowDepth="0" BlurRadius="24"/>
                    </Border.Effect>
                    <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="32">
                        <StackPanel>
                            <!-- Question Header -->
                            <Grid Margin="0,0,0,24">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <StackPanel Grid.Column="0">
                                    <TextBlock FontSize="24" FontWeight="SemiBold" 
                                            Foreground="{StaticResource DarkText}" VerticalAlignment="Center" Margin="0,0,0,8">
                                        <TextBlock.Text>
                                            <MultiBinding StringFormat="Câu hỏi {0}/{1}">
                                                <Binding Path="CurrentQuestionIndex" Converter="{StaticResource AddOneConverter}"/>
                                                <Binding Path="TotalQuestions"/>
                                            </MultiBinding>
                                        </TextBlock.Text>
                                    </TextBlock>
                                    
                                    <!-- Multiple Choice Instructions -->
                                    <TextBlock FontSize="14" Foreground="{StaticResource LightText}" 
                                               Visibility="{Binding CurrentQuestion.IsMultipleChoice, Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <TextBlock.Text>
                                            <MultiBinding StringFormat="(Chọn {0} đáp án)">
                                                <Binding Path="CurrentQuestion.CorrectAnswerCount"/>
                                            </MultiBinding>
                                        </TextBlock.Text>
                                    </TextBlock>
                                </StackPanel>

                                <Button Grid.Column="1" 
                                        Style="{StaticResource MarkButtonStyle}" 
                                        Command="{Binding MarkQuestionCommand}">
                                    <Button.Content>
                                        <Binding Path="CurrentQuestionNumberItem.IsMarked" 
                                                 Converter="{StaticResource IsMarkedToTextConverter}"/>
                                    </Button.Content>
                                </Button>
                            </Grid>

                            <!-- Question Content -->
                            <TextBlock Text="{Binding CurrentQuestion.Content}" 
                                    FontSize="18" Foreground="{StaticResource DarkText}" 
                                    TextWrapping="Wrap" 
                                    Margin="0,0,0,24" 
                                    LineHeight="28"/>

                            <!-- Question Image (if exists) -->
                            <Image Source="{Binding CurrentQuestion.ImageUrl}" 
                                MaxHeight="300" 
                                Margin="0,0,0,24"
                                HorizontalAlignment="Left"
                                Visibility="{Binding CurrentQuestion.ImageUrl, 
                                            Converter={StaticResource NullToVisibilityConverter}}"/>

                            <!-- Answer Options with proper template selection -->
                            <ContentPresenter>
                                <ContentPresenter.Content>
                                    <Binding Path="CurrentQuestion"/>
                                </ContentPresenter.Content>
                                <ContentPresenter.ContentTemplateSelector>
                                    <local:AnswerTemplateSelector/>
                                </ContentPresenter.ContentTemplateSelector>
                                <ContentPresenter.Resources>
                                    <!-- Single Choice Template -->
                                    <DataTemplate x:Key="SingleChoiceTemplate">
                                        <ItemsControl ItemsSource="{Binding Answers}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <RadioButton Style="{StaticResource AnswerRadioButtonStyle}"
                                                                GroupName="{Binding DataContext.CurrentQuestion.QuestionId, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                IsChecked="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                                Checked="RadioButton_Checked">
                                                        <RadioButton.Tag>
                                                            <MultiBinding Converter="{StaticResource IndexToAlphabetConverter}">
                                                                <Binding RelativeSource="{RelativeSource AncestorType=ItemsControl}" 
                                                                       Path="ItemsSource"/>
                                                                <Binding/>
                                                            </MultiBinding>
                                                        </RadioButton.Tag>
                                                        <TextBlock Text="{Binding Content}" TextWrapping="Wrap"/>
                                                    </RadioButton>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </DataTemplate>
                                    
                                    <!-- Multiple Choice Template -->
                                    <DataTemplate x:Key="MultipleChoiceTemplate">
                                        <ItemsControl ItemsSource="{Binding Answers}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <CheckBox Style="{StaticResource AnswerCheckBoxStyle}"
                                                              IsChecked="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                              Checked="CheckBox_Checked"
                                                              Unchecked="CheckBox_Unchecked">
                                                        <CheckBox.Tag>
                                                            <MultiBinding Converter="{StaticResource IndexToAlphabetConverter}">
                                                                <Binding RelativeSource="{RelativeSource AncestorType=ItemsControl}" 
                                                                       Path="ItemsSource"/>
                                                                <Binding/>
                                                            </MultiBinding>
                                                        </CheckBox.Tag>
                                                        <TextBlock Text="{Binding Content}" TextWrapping="Wrap"/>
                                                    </CheckBox>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </DataTemplate>
                                </ContentPresenter.Resources>
                            </ContentPresenter>
                        </StackPanel>
                    </ScrollViewer>
                </Border>

                <!-- Practice Exam Content -->
                <Border Grid.Row="0" Background="{StaticResource CardBackground}" Margin="24" CornerRadius="16" 
        BorderBrush="{StaticResource BorderColor}" BorderThickness="1"
        Visibility="{Binding ExamType, Converter={StaticResource ExamTypeToVisibilityConverter}, ConverterParameter=Practice}">
                    <Border.Effect>
                        <DropShadowEffect Color="#000000" Opacity="0.08" ShadowDepth="0" BlurRadius="24"/>
                    </Border.Effect>
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <!-- Question Header -->
                        <Border Grid.Row="0" Padding="32,32,32,24">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <StackPanel Grid.Column="0">
                                    <TextBlock FontSize="24" FontWeight="SemiBold" 
        Foreground="{StaticResource DarkText}" Margin="0,0,0,8">
                                        <TextBlock.Text>
                                            <MultiBinding StringFormat="Câu hỏi {0}/{1}">
                                                <Binding Path="CurrentQuestionIndex" Converter="{StaticResource AddOneConverter}"/>
                                                <Binding Path="TotalQuestions"/>
                                            </MultiBinding>
                                        </TextBlock.Text>
                                    </TextBlock>

                                    <TextBlock FontSize="18" Foreground="{StaticResource DarkText}" 
        TextWrapping="Wrap" 
        LineHeight="28"
        Margin="0,0,0,16">
                                        <TextBlock.Text>
                                            <Binding Path="CurrentPracticeQuestion.Content" FallbackValue="[DEBUG] No Content Bound" TargetNullValue="[DEBUG] Content is NULL"/>
                                        </TextBlock.Text>
                                    </TextBlock>
                                </StackPanel>

                                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Top">
                                    <Border Background="{StaticResource IconBackground}" 
        BorderBrush="{StaticResource BorderColor}" 
        BorderThickness="1"
        CornerRadius="8" 
        Padding="8,4" 
        Margin="0,0,12,0">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="🏆" FontSize="12" Margin="0,0,4,0" VerticalAlignment="Center"/>
                                            <TextBlock FontSize="12" FontWeight="SemiBold" Foreground="{StaticResource LightText}" VerticalAlignment="Center">
                                                <TextBlock.Text>
                                                    <MultiBinding StringFormat="{}{0} điểm">
                                                        <Binding Path="CurrentPracticeQuestion.Score"/>
                                                    </MultiBinding>
                                                </TextBlock.Text>
                                            </TextBlock>
                                        </StackPanel>
                                    </Border>

                                    <Button Style="{StaticResource MarkButtonStyle}" 
        Command="{Binding MarkQuestionCommand}">
                                        <Button.Content>
                                            <Binding Path="CurrentQuestionNumberItem.IsMarked" 
                                Converter="{StaticResource IsMarkedToTextConverter}"/>
                                        </Button.Content>
                                    </Button>
                                </StackPanel>
                            </Grid>
                        </Border>

                        <!-- Answer Section - ITEMSCONTROL để tạo editor riêng cho từng câu -->
                        <Grid Grid.Row="1" Margin="32,0,32,32">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <!-- Header của vùng trả lời -->
                            <TextBlock Grid.Row="0" 
                Text="📝 Phần trả lời"
                FontSize="16" 
                FontWeight="SemiBold"
                Foreground="{StaticResource DarkText}"
                Margin="0,0,0,12"/>

                            <!-- ItemsControl để hiển thị editor cho từng question -->
                            <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                                <ItemsControl ItemsSource="{Binding AllPracticeQuestions}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="{StaticResource IconBackground}"
                                                    BorderBrush="{StaticResource BorderColor}"
                                                    BorderThickness="1"
                                                    CornerRadius="12"
                                                    Margin="0,0,0,16">
                                                <Border.Style>
                                                    <Style TargetType="Border">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding IsCurrent}" Value="True">
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Border.Style>
                                                <Grid>
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="*"/>
                                                    </Grid.RowDefinitions>
                                                    <!-- Toolbar để chọn mode -->
                                                    <Border Grid.Row="0" 
                                                            Background="{StaticResource BorderColor}" 
                                                            CornerRadius="12,12,0,0"
                                                            Padding="12,8">
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="Chế độ: " 
                                                                       FontSize="12" 
                                                                       VerticalAlignment="Center"
                                                                       Foreground="{StaticResource LightText}"/>
                                                            <ComboBox SelectedIndex="0"
                                                                      FontSize="12"
                                                                      MinWidth="120"
                                                                      Tag="{Binding PracticeQuestionId}"
                                                                      IsEnabled="{Binding DataContext.CanInteractWithExam, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                      SelectionChanged="AnswerModeComboBox_SelectionChanged">
                                                                <ComboBoxItem Content="📝 Văn bản" Tag="Text"/>
                                                                <ComboBoxItem Content="💻 C# Code" Tag="CSharp"/>
                                                                <ComboBoxItem Content="🐍 Python" Tag="Python"/>
                                                                <ComboBoxItem Content="☕ Java" Tag="Java"/>
                                                                <ComboBoxItem Content="📊 SQL" Tag="SQL"/>
                                                            </ComboBox>
                                                        </StackPanel>
                                                    </Border>
                                                    <!-- AvalonEdit Editor riêng biệt cho từng câu -->
                                                    <avalonedit:TextEditor Grid.Row="1"
                                                                         Tag="{Binding PracticeQuestionId}"
                                                                         FontFamily="Consolas"
                                                                         FontSize="14"
                                                                         ShowLineNumbers="True"
                                                                         SyntaxHighlighting="Text"
                                                                         Padding="16"
                                                                         BorderThickness="0"
                                                                         Background="{StaticResource CardBackground}"
                                                                         WordWrap="True"
                                                                         MinHeight="200"
                                                                         IsEnabled="{Binding DataContext.CanInteractWithExam, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                         Loaded="PracticeAnswerEditor_Loaded"
                                                                         TextChanged="PracticeAnswerEditor_TextChanged"
                                                                         ToolTip="{Binding PracticeQuestionId, StringFormat='QuestionID: {0}'}" />
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </Grid>
                    </Grid>
                </Border>
            </Grid>
        </Grid>

        <!-- Loading Overlay -->
        <Border Background="#80000000" 
                Grid.ColumnSpan="2"
                Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"
                Panel.ZIndex="100">
            <Border Background="{StaticResource CardBackground}" 
                    CornerRadius="16" 
                    Padding="32"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    BorderThickness="1"
                    BorderBrush="{StaticResource BorderColor}">
                <Border.Effect>
                    <DropShadowEffect Color="#000000" Opacity="0.08" ShadowDepth="0" BlurRadius="24"/>
                </Border.Effect>
                <StackPanel>
                    <ProgressBar IsIndeterminate="True" 
                               Width="200" Height="4" 
                               Margin="0,0,0,16"
                               Foreground="{StaticResource PrimaryColor}"/>
                    <TextBlock Text="Đang tải bài thi..." 
                             FontSize="16" 
                             Foreground="{StaticResource LightText}"
                             HorizontalAlignment="Center"/>
                </StackPanel>
            </Border>
        </Border>

        <!-- Penalty Overlay - Background màu đỏ nhẹ khi bị phạt -->
        <Border Background="#40E53E3E" 
                Grid.ColumnSpan="2"
                Visibility="{Binding IsInPenalty, Converter={StaticResource BooleanToVisibilityConverter}}"
                Panel.ZIndex="98">
            <!-- Chỉ làm background màu đỏ nhẹ, không có nội dung -->
        </Border>
    </Grid>
</Window>